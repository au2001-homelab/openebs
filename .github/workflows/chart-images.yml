name: Helm Chart Images CI
on:
  push:
    branches:
      - develop
      - 'release/**'
  pull_request:
    types: [ 'opened', 'edited', 'reopened', 'synchronize' ]
  workflow_call:

env:
  CI: 1

jobs:
  helm-images:
    runs-on: oracle-vm-8cpu-32gb-x86-64
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - id: nixpath
        run: echo "nix_path=nixpkgs=$(jq -r '.nixpkgs.url' nix/sources.json)" >> $GITHUB_OUTPUT
      - uses: cachix/install-nix-action@v31.3.0
        with:
          nix_path: "${{ steps.nixpath.outputs.nix_path }}"
          enable_kvm: true
      - name: Setup Nix Path
        run: |
          export NIX_PATH=nixpkgs=$(jq '.nixpkgs.url' nix/sources.json -r)
          echo "NIX_PATH=$NIX_PATH" >> $GITHUB_ENV
      - name: Pre-populate K8s nix-shell
        run: nix-shell ./scripts/k8s/shell.nix --run "echo"
      - name: Pre-populate helm nix-shell
        run: nix-shell ./scripts/helm/shell.nix --run "echo"
      - name: Generate image list
        run: nix-shell ./scripts/helm/shell.nix --run "./scripts/helm/images.sh generate --dependency-update --exit-code"
      - name: Patch chart/Chart.yaml
        run: nix-shell ./scripts/helm/shell.nix --run "./scripts/helm/images.sh patch --exit-code"
      - name: Login to DockerHub
        uses: docker/login-action@v3
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        if: ${{ env.DOCKERHUB_USERNAME != '' }}
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: BootStrap k8s cluster
        run: |
          sudo debconf-communicate <<< "set man-db/auto-update false" || true
          sudo dpkg-reconfigure man-db || true
          nix-shell ./scripts/k8s/shell.nix --run "./scripts/k8s/deployer.sh start --mayastor --zfs --lvm --label"
      - name: Install helm chart
        run: nix-shell ./scripts/helm/shell.nix --run "./scripts/helm/install.sh --mayastor --zfs --lvm --rawfile --wait"
      - name: Verify image list
        run: nix-shell ./scripts/helm/shell.nix --run "./scripts/helm/images.sh verify"
